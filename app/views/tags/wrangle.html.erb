<h2><%= 'Wrangle Tags for ' + link_to_tag(@tag) %></h2>

<p><%= tag_comment_link(@tag) %></p>  

<p><%= link_to 'edit tag and parent associations', {:controller => :tags, :action => :edit, :id => @tag} %></p>

<%- if params[:show] -%>
  <h3><%= "Showing " + params[:show] %></h3>
<%- end -%>

<%= tag_wrangler_footer %>

<%- if @tag.canonical? && !@tag.child_types.empty? -%>
<h4>Choose a group of tags to show:</h4>
<ul>
  <%- for tag_type in @tag.child_types -%>
    <li>
      <%= link_to tag_type.pluralize + " (#{@counts[tag_type.underscore.pluralize.to_sym]})", url_for(:show => tag_type.underscore.pluralize) %>
    </li>
  <%- end -%>
</ul>
<%- end -%>

<%- if params[:show] -%>
  <h3>Add new <%= params[:show] %></h3>
  <%- form_for :tag, @tag, :url => { :action => "update", :id => @tag}, :html => { :method => :put } do |f| -%>
    <%= f.text_area "#{params[:show].singularize}_string", :size => "100x5" %>
    <%= autocomplete_text_field "tag_#{params[:show].singularize}_string" -%>
    <%= f.submit 'Add' %>    
  <%- end -%>
<%- end -%>

<%- if @tags && @tags.empty? -%>
  <p>There are no tags in this category at the moment.</p>
<%- elsif @tags -%>
  <h4>Filter by tag status:</h4>
  <ul>
    <li><%= link_to 'all', url_for(:show => params[:show], :status => 'all') %></li>
    <li><%= link_to 'canonical', url_for(:show => params[:show], :status => 'canonical') %></li>
    <li><%= link_to 'non-canonical', url_for(:show => params[:show], :status => 'noncanonical') %></li>
    <li><%= link_to 'unfilterable', url_for(:show => params[:show], :status => 'unfilterable'), :title => "non-canonical tags without synonyms" %></li>
    <li><%= link_to 'unwrangled', url_for(:show => params[:show], :status => 'unwrangled'), :title => "tags which were used on the same works but haven't been wrangled yet" %></li>
  </ul>
  
  <%- if @tag.is_a?(Fandom) && params[:show] == "pairings" -%>
  <p><%= link_to "wrangle pairings to characters", tag_wranglings_path(:show => 'character_pairings', :fandom_string => @tag.name) %></p>
  <%- end -%>
  
  <%- form_tag url_for(:controller => 'tags', :action => 'mass_update'), :method => :post, :id => 'wrangulator' do -%>   
    <p class="submit"><%= submit_tag "Wrangle" %></p>
    <table>
      <tr>
        <th>
          <%- if params[:sort] == "name DESC" -%>
            <%= link_to "Tag Name", url_for(:show => params[:show], :sort => "name ASC") %>
          <%- else -%>
            <%= link_to "Tag Name", url_for(:show => params[:show], :sort => "name DESC") %>          
          <%- end -%>
        </th>
        <%- if params[:show] == "pairings" -%>
        <th>Characters</th>
        <%- end -%>      
        <th>Canonical</th>
        <th>Synonym</th>
        <th>
          <%- if params[:sort] == "created_at DESC" -%>
            <%= link_to "Created", url_for(:show => params[:show], :sort => "created_at ASC") %>
          <%- else -%>
            <%= link_to "Created", url_for(:show => params[:show], :sort => "created_at DESC") %>          
          <%- end -%>        
        </th>
        <th>
          <%- if params[:sort] == "taggings_count DESC" -%>
            <%= link_to "Taggings Count", url_for(:show => params[:show], :sort => "taggings_count ASC") %>
          <%- else -%>
            <%= link_to "Taggings Count", url_for(:show => params[:show], :sort => "taggings_count DESC") %>          
          <%- end -%>        
        </th>    
      </tr>
      <%- for tag in @tags -%>
      <tr>
        <%- if params[:show] == "pairings" -%>
        <td>
          <%= label_tag "selected_tags_#{tag.id}", "#{tag.name}" %>
          <span class="fake-tooltip">
            <%= link_to 'edit', {:controller => :tags, :action => :edit, :id => tag} %> | 
            <%= link_to 'wrangle', {:controller => :tags, :action => :wrangle, :id => tag} %> | 
            <%= link_to 'works', {:controller => :works, :action => :index, :tag_id => tag} %>
          </span>
        </td>
        <%- else -%>      
        <td>
          <%= tag.name %>
          <span class="fake-tooltip">
            <%= link_to 'edit', {:controller => :tags, :action => :edit, :id => tag} %> | 
            <%= link_to 'wrangle', {:controller => :tags, :action => :wrangle, :id => tag} %> | 
            <%= link_to 'works', {:controller => :works, :action => :index, :tag_id => tag} %>
          </span>
        </td>
        <%- end -%>
        <%- if params[:show] == "pairings" -%>
        <td>
          <%- unless !tag.canonical? || tag.characters.empty? -%>
          <ul><%= tag_link_list(tag.characters) %></ul>
          <%- end -%>
        </td>
        <%- end -%>        
        <td><%= check_box_tag "canonicals[]", tag.id, tag.canonical?, :id => "canonicals_#{tag.id}", :disabled => (tag.canonical? && (!tag.mergers.empty? || !tag.children.empty?)) -%></td>
        <td><%- if tag.merger -%><%= link_to_tag(tag.merger) %><%- end -%></td>
        <td><%= tag.created_at.to_date %></td>
        <td><%= tag.taggings_count %></td>
      </tr>
      <%- end -%>
    </table>
    <p>
    <%= hidden_field_tag :show, params[:show] %> 
    <%= hidden_field_tag :sort, params[:sort] %>
    <%= hidden_field_tag :page, params[:page] %>
    <%= hidden_field_tag 'tag_ids', @tags.collect(&:id).join(',') %> 
    </p>
    <p class="submit"><%= submit_tag "Wrangle" %></p>
  <%- end -%>

  <%= will_paginate @tags %>  
<%- end -%>

<%= tag_wrangler_footer %>