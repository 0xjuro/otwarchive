<!--Descriptive page name and system messages, descriptions, and instructions.-->
<% if @user %>
<h2><%=h t('owned_collections', :default => "{{user_name}}'s Collections", :user_name => @user.login) %></h2>
<% elsif @collection %>
<h2><%=h t('listing_sub_collections', :default => "Challenges/Subcollections in {{collection_name}}", :collection_name => @collection.title) %></h2>
<% elsif @work -%>
<h2><%=h t('listing_work_collections', :default => "Collections including {{work_name}}", :work_name => @work.title) %></h2>
<% else %>
<h2><%=h t('listing_collections', :default => "Collections in the {{archive_name}}", :archive_name => ArchiveConfig.APP_NAME) %></h2>
<% end %>
<!--/descriptions-->

<!--Subnavigation, sorting and actions-->
<%- if logged_in? %>
<h3 class="landmark">Navigation</h3>
<ul class="navigation" role="navigation">
  <% if @user && @user == current_user %>
    <li><%= link_to t('collections.my_collection_items', :default => "Manage Collected Works"), user_collection_items_path(@user) -%></li>
  <% end %>
	<li><%= link_to t('collections.new_collection', :default => "New Collection"), new_collection_path %></li>
</ul>
<% end -%>
<!--pagination here-->

<%- if @sort_and_filter -%> 
<!--sorting subnav-->
<div class="navigation module">
  <ul class="sorting navigation" role="navigation">
    <li><h4><%= t('sort_by', :default => 'Sort By') -%></h4></li>
    <li><%= sort_link t('sort.title', :default => 'Title'), :title -%></li>
    <li><%= sort_link t('sort.date', :default => 'Date'), :created_at -%></li>
    <li><%= sort_link t('sort.size', :default => 'Size'), :count -%></li>
  </ul>
</div>
<!---/subnav-->
<%- end -%>

<!--main content-->

<h3 class="landmark">List of Collections</h3>
<ul class="collection index">
<% @collections.each do |collection| %>
  <li class="collection blurb">
  	<ul class="collection<% if collection.user_is_owner?(current_user) %> own<%- end -%>">
 		<li class="heading">
			<h4 title="name"><%= link_to sanitize_title_for_display(collection.title, :tags => %w(em i b strong strike small)), collection_path(collection) -%>
				<span>(<%=h collection.name -%>)</span>
					<%= t('collection_by_owner', :default => 'by') -%>
					<%= collection.all_owners.map {|owner| link_to(owner.byline, owner.user)}.join(", ") -%></h4>
					<!--collections header iconised header image-->
			<p class="update"><!--collection updated at--></p>
	</li>

<%- cache("collections-#{collection.id}", :expires_in => AdminSetting.cache_expiration.minutes ) do -%>
	<% if collection.all_moderators.length > 0%>
	<li>
		<dl class="mods">
		<dt>Mods</dt>
		<dd>
			<ul>
			  <%= collection.all_moderators.map {|mod| "<li>#{link_to(mod.byline, mod.user)}</li>"}.join(", ") -%>
			</ul>
		</dd>
		</dl>
	</li>
	<% end -%>
	<!--unless tags are less than one
	<li>
		<dl class="tags">
		<dt>Tags</dt>
		<dd>
			<ul>
				<li>link to tag</li>
				...
			</ul>
		</dd>
		</dl>
	</li>
	-->
	<li class="summary" title="description">
	  <blockquote class="user-generated-view"><%= sanitize_strip_images_and_format_for_display collection.description %></blockquote>

    <p class="type">(<%= collection.closed? ? t('collections_index.is_closed', :default => "Closed") : t('collections_index.open', :default => "Open") %>, <%= collection.moderated? ? t('collections_index.is_moderated', :default => "Moderated") : t('collections_index.unmoderated', :default => "Unmoderated") %><%= collection.unrevealed? ? t('collections_index.is_unrevealed', :default => ", Unrevealed") : "" %><%= collection.anonymous? ? t('collections_index.is_anonymous', :default => ", Anonymous") : "" %><%= collection.gift_exchange? ? t('collections_index.is_gift_exchange', :default => ", Gift Exchange") : "" %>)</p>
	</li>

	<%- if collection.not_empty? -%>
	<li class="stats" title="stats">
		<dl>
      <% if (@challenges_count = collection.children.count) > 0%>
      <dt><%= t('collections.children', :default => "Challenges/Subcollections") -%></dt>
        <dd><%= link_to(@challenges_count, collection_collections_path(collection)) -%></dd>
      <% end %>
			<% if (@works_count = collection.all_approved_works_count) > 0%>
			<dt><%=h t('fandoms', :default => "Fandoms") %></dt>
    		<dd><%= link_to(collection.all_fandoms_count, collection_fandoms_path(collection)) -%></dd>			
			<dt><%=h t('works', :default => "Works") %></dt>
    		<dd><%= link_to(@works_count, collection_works_path(collection)) -%></dd>
  		<% end %>
			<% if (@bookmarks_count = collection.all_approved_bookmarks_count) > 0%>
     	<dt><%=h t('bookmarks', :default => "Bookmarks") %></dt>
	      <dd><%= link_to(@bookmarks_count, collection_bookmarks_path(collection)) -%></dd>
			<% end %>
	  </dl>
  </li>
  <%- end -%>
<%- end -%>  
  <% if collection.user_is_owner?(current_user) %>
	  <li class="navigation"><%= link_to 'Edit', edit_collection_path(collection) %></li>
  <% end %>
</ul>
</li>
<% end %>
</ul>

<%- if @sort_and_filter -%>
<!--filters subnav-->
<h3 class="landmark">Filters</h3>
<%- form_tag collections_url, :method => :get, :class => 'filters' do -%>
  <%- field_set_tag t('filter_these', :default => 'Filter collections:') do -%>
 		<dl class="filters" role="complementary navigation">
      <dt><%= label_tag 'collection_filters_title', "Filter by title" %></dt>
      <dd>
        <%= text_field_tag 'collection_filters[title]', params[:collection_filters][:title] %>
        <%= autocomplete_text_field "collection_filters_title" -%>        
      </dd>
      <dt><%= label_tag 'collection_filters_fandom', "Filter by fandom" %></dt>
      <dd>
        <%= text_field_tag 'collection_filters[fandom]', params[:collection_filters][:fandom] %>
        <%= autocomplete_text_field "collection_filters_fandom" -%>
      </dd>
      <dt>Closed</dt>
      <dd>
        <%= radio_button_tag "collection_filters[closed]", true, params[:collection_filters][:closed] == "true" -%>
        <%= label_tag "collection_filters_closed_true", "Yes" %>    
        <%= radio_button_tag "collection_filters[closed]", false, params[:collection_filters][:closed] == "false" -%>
        <%= label_tag "collection_filters_closed_false", "No" %>      
      </dd>
      <dt>Moderated</dt>
      <dd>
        <%= radio_button_tag "collection_filters[moderated]", true, params[:collection_filters][:moderated] == "true" -%>
        <%= label_tag "collection_filters_moderated_true", "Yes" %>    
        <%= radio_button_tag "collection_filters[moderated]", false, params[:collection_filters][:moderated] == "false" -%>
        <%= label_tag "collection_filters_moderated_false", "No" %>      
      </dd>
      <dt>Gift Exchange</dt>
      <dd>
        <%= radio_button_tag "collection_filters[gift_exchange]", true, params[:collection_filters][:gift_exchange] == "true" -%>
        <%= label_tag "collection_filters_gift_exchange_true", "Yes" %>    
        <%= radio_button_tag "collection_filters[gift_exchange]", false, params[:collection_filters][:gift_exchange] == "false" -%>
        <%= label_tag "collection_filters_gift_exchange_false", "No" %>      
      </dd>
    </dl>
    <div class="clear"><!--purely presentational for IE6; phase me out--></div>
    <p class="submit"><%= submit_tag "Filter" %></p>
  <%- end -%>
<%- end -%>
<!---/subnav-->
<%- end -%> 
<div class="clear"><!-- presentational--></div>

<%= will_paginate @collections, {:previous_label => '&laquo; Previous', :next_label => 'Next &raquo;'} %>